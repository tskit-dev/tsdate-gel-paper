This folder contains all the code used to generate figures in the manuscript that rely on simulated or publicly available data.

# Requirements

To run code in this folder, you will need a `python` 3.9+ installation. If you are on Windows, please use the Windows Subsystem for Linux (WSL) to run commands. The required packages can be installed with

```
python -m pip install -r requirements.txt
```

An R installation is also needed to produce one table (Table S8) as discussed below. Unless otherwise specified, all paths below are relative to the `scripts` directory.

# Snakemake pipelines

Each pipeline has its own folder in this directory. If all the input and output paths are correctly configured for your machine, each can be run with the `snakemake --cores all` command.

* `stdpopsim-benchmarks`: Compares accuracy of variational gamma (VG) and inside-outside (IO) algorithms of `tsdate` (Figure S1).
* `performance-benchmarks`: Computational performance evaluation of dating method (Figure S2).
* `convergence-benchmark`: Uses simulated data to evaluate `tsdate` convergence, as shown in Figure S3.
* `uncertainty-benchmarks`: Analyses the calibration of `tsdate` VG posteriors (Figure S4).
* `tgp_comparison`: Compares allele age estimates from five methods on chr20 of the 1KGP data (Figure S10). Requires ~18 GB of data obtained from various sources. Please contact us if you'd like to run this analysis and we would be happy to assist.

# Makefile for sampling simulation

One Makefile was created (`base_dir/makefiles/sampling_sim.mk`) to produce the large intermediate data files that are needed to make Table S8 and Figure S11. To run it from the base directory:

```
cd tools && make #from base directory
make -f ../makefiles/sampling_sim.mk SLIM_PATH="tools/SLiM/build/slim"
```

The same result can also be recreated more laboriously using these separate scripts, implemented for running on HPC:

* `sampling_sim_stdpopsim.py` to run the sims (call as `python sampling_sim_stdpopsim.py balanced --slim_path ../tools/SLiM/build/slim` and `python sampling_sim_stdpopsim.py unbalanced --slim_path ../tools/SLiM/build/slim`: defaults to n=60k)
* `sampling_sim_tsinfer.py` to run tsinfer on the output of those sims (call as `python sampling_sim_tsinfer.py balanced` and `python sampling_sim_tsinfer.py unbalanced` - it should pick up on the n=60k file, unless you have run other sample sizes)
* `sampling_sim_tsdate.py` to run tsdate on that tsinfer output (likewise call as `python sampling_sim_tsdate.py balanced` and `python sampling_sim_tsdate.py unbalanced`)

# Dating external trees

* `perf_sim_tsdate.py` uses tsdate to date the simulated chr17 from [Anderson-Trocme et al](https://www.science.org/doi/abs/10.1126/science.add5300) (https://zenodo.org/records/7702392)
* `validation_real_tsdate.py` uses tsdate to date a portion of inferred 1KGP ARGs for chr20 (will be uploaded to Zenodo)

# Combined CLI scripts for data generation and plotting

The `make_figure_data.py` script makes various datasets in compressed `csv.zst` format that are needed for the plots. The compressed files are included in the repository but can be regenerated as follows (for what they relate to, see their corresponding plot commands):

* `make_figure_data.py pedigree_sim`: Requires the data generated by `perf_sim_tsdate.py` above.
* `make_figure_data.py sampling_sim`: Requires the data generated by the Makefile above.
* `make_figure_data.py validation_aDNA 20`: The 20 argument specifies the chromosome, which defaults to chr20. Require the Makefile in `data/aDNA` and inferred 1KGP ARGs for chr20 to be run. The inferred ARGs will be uploaded to Zenodo. 
* `make_figure_data.py validation_OOA`: Requires the data generated by `validation_real_tsdate.py` above
* `make_figure_data.py validation_inversion`: Requires inferred 1KGP ARGs to be run. The inferred ARGs will be uploaded to Zenodo.

Additional commands for generating 1KGP-related data require various data (inferred ARGs and related files) that will be uploaded to Zenodo:

* `make_figure_data.py tgp_singleton`
* `make_figure_data.py tgp_subset`
* `make_figure_data.py tgp_table`: Produces data needed to produce the table summary of 1KGP inference.

The corresponding plots are produced by `plot.py` using the `.csv.zst` files:

* `plot.py pedigree_sim`: Plots an evaluation of tsinfer+tsdate using a large pedigree dataset (Figure 2)
* `plot.py sampling_sim`: Test robustness of allele ages/frequencies to unbalanced sampling (Figure S11)
* `plot.py validation_aDNA`: Allele ages from tsinfer+tsdate are plotted against lower bound age estimates from the Allen Ancient DNA Resource (Figure S5)
* `plot.py validation_OOA`: Compares PHLASH and tsinfer+tsdate estimates for the Out-of-Africa bottleneck time period (Figure S6)
* `plot.py validation_inversion`: Compares age estimates for a chromosome 17 inversion from Relate and tsinfer+tsdate (Figure S7)
* `plot.py tgp_subset`: Assesses the dependence on smple size of tsinfer+tsdate age estimates on the 1KGP dataset (Figure S8)
* `plot.py tgp_singleton`: Evaluates phase-agnostic singleton age estimates on the 1KGP dataset (Figure S9).

# Standalone scripts

These can be run without any arguments.

* `algorithmic_schematic.py`: Makes the schematic diagram in Figure 1.
* `sequence_length_accuracy_benchmark.py` Tests the bias in `tsdate` age estimates due to short sequence length (Figure S12)
* `algorithmic_schematic_supp.py`: Produces the additional schematic in Figure S26.
* `polytomy_bias_correction.py`: Tests the effect of polytomies on `tsdate` allele age estimates (Figure S27)
* `phasing_benchmark.py`: Evaluates phase-agnostic dating performance (Figure S28).
* `simulation_selection_analysis.r` Summarises results of various linear models comparing mutation age vs allele frequency (Table S8). Requires R to be installed.
* `contig_table.py`: Prints the summary of GEL (Table S2) and 1KGP (Table S7) inference statistics.
